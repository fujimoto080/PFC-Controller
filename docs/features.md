# PFC Balance 機能ドキュメント

## 1. アプリ概要

PFC Balance は、**タンパク質（P）・脂質（F）・炭水化物（C）・カロリー**の記録と目標管理を行うアプリです。日次・週次・月次で摂取状況を可視化し、食品辞書やバーコード連携で入力効率を高められます。

---

## 2. 画面一覧（主要導線）

下部ナビゲーションから次の画面へ遷移できます。

- **ホーム**（`/`）
- **履歴**（`/log`）
- **追加**（`/add`）
- **カレンダー**（`/calendar`）
- **食品管理**（`/manage-foods`）

補助ページ:

- **バーコードマッピング一覧**（`/barcode-mappings`）
- **プライバシーポリシー**（`/privacy-policy`）

---

## 3. ホーム（ダッシュボード）機能

### 3.1 日次PFCダッシュボード
- 当日または任意日の摂取量（kcal / P / F / C）を表示
- 目標値に対する進捗をプログレス表示
- 左右ボタンおよびスワイプで日付移動
- 今日以外の日付も確認可能

### 3.2 PFC負債の反映
- 過去日の超過分を「負債」として表示
- カロリーは `目標 - 負債` で実効目標を計算
- P/F/C も負債を表示し、累積超過を把握可能

### 3.3 よく使う食べ物（クイック追加）
- お気に入り登録した食品を横並びボタンで表示
- ワンタップで現在時刻の記録として追加

### 3.4 週平均サマリー
- 過去7日間の平均摂取量（kcal / P / F / C）を表示
- 日次目標に対する平均進捗を可視化

### 3.5 目標編集（自動計算対応）
- 設定アイコンから目標編集ドロワーを開く
- プロフィール入力により目標PFCを自動計算
- 計算後の目標を保存

---

## 4. 追加画面（食事登録）機能

### 4.1 基本入力
- 食べた**日付・時刻**を指定して登録
- 食品名、P/F/C、カロリー、店名を入力
- 必要に応じて食品辞書へ同時保存

### 4.2 バーコード読み取り
- カメラ起動でバーコードをスキャン
- JAN/EAN/UPC/ITF/Code128 等に対応
- チェックデジット検証で不正読み取りを抑制

### 4.3 バーコードマッピング参照・登録
- コード入力で既存マッピングを照会
- マッピングがあればフォームへ自動反映
- 記録時、該当バーコードへ食品情報を保存可能
- マッピング一覧ページへの導線あり

### 4.4 写真タブ（AI補助入力）
- カメラ入力UIは存在
- 食べた内容をテキストで入力し、Gemini API でP/F/Cとカロリーを推定
- 推定結果を手動入力フォームへ反映し、そのまま保存可能

---

## 5. 履歴画面機能

### 5.1 一覧表示
- すべての記録を新しい順で表示
- 日付ごとにグルーピング

### 5.2 同一食品の集約
- 同名かつ同PFCの記録を1グループに集約
- 件数・合計kcal・合計PFCを表示
- 複数件グループは展開して個別レコードを確認

### 5.3 履歴からの再利用
- **呼び出し**: 既存内容を初期値として追加フォームを開く
- **再登録**: 現在時刻で即時再登録

### 5.4 記録編集・削除
- ドロワーで食品名・日時・PFC・カロリーを編集
- 記録削除に対応
- 日時変更で日付をまたぐ移動にも対応

### 5.5 ページング
- 初期100件表示、追加読み込みで件数拡張

---

## 6. カレンダー（月間サマリー）機能

### 6.1 月間カレンダー
- 月移動（前月/翌月）
- 日ごとの摂取カロリー表示
- 目標超過日は強調色表示
- 当日ハイライト

### 6.2 週進捗の可視化
- 各週の合計カロリーを縦バー表示
- 週目標（`日次目標 × 7`）に対する超過判定

### 6.3 月間集計
- 当月総摂取カロリー
- 記録日の平均摂取カロリー

---

## 7. 食品管理機能

### 7.1 食品辞書の管理
- 食品の新規追加
- 既存食品の編集
- 食品削除
- 検索

### 7.2 店舗・グループ管理
- 店舗（store）と店内グループ（storeGroup）で階層表示
- 店舗単位・グループ単位の折りたたみ状態を保存
- 複数選択して店舗/グループを一括更新

### 7.3 並び替え・移動
- グループ内の食品順をドラッグ&ドロップで変更
- グループ順もドラッグ&ドロップで変更
- 食品を他店舗/他グループへ移動可能

### 7.4 お気に入りと即時記録
- 星アイコンでお気に入り切替
- 食品行からそのままログ追加

### 7.5 記録日時の指定
- 食品管理画面から追加する際も日付・時刻を指定可能

---

## 8. 目標自動計算（プロフィール連動）

プロフィール項目:
- 性別
- 年齢
- 身長
- 現在体重
- 目標体重
- 活動レベル
- 目標期間（月）

計算の考え方:
- BMR（基礎代謝）を算出
- 活動レベルからTDEE（維持カロリー）を算出
- 目標体重・期間から1日あたり調整カロリーを算出
- 最低安全カロリー（男性1500 / 女性1200）を下限適用
- 推奨PFCを表示
- 5%ルール等を使った推奨減量期間の目安表示

---

## 9. バーコード連携機能

### 9.1 API
- `GET /api/barcode?code=...` : バーコードから食品情報を取得
- `POST /api/barcode` : バーコードへ食品情報を保存
- `POST /api/intake-logs` : 外部AIなどから摂取履歴を登録
- `GET /api/intake-logs` : 登録済みの摂取履歴を取得（limit/startAt/endAt対応）

### 9.2 永続化
- Upstash Redis を使用してバーコードマッピングを保存
- 追加済みバーコードはインデックス管理し一覧取得可能

### 9.3 管理画面
- ` /barcode-mappings ` で登録済みのバーコードとPFC情報を一覧表示

---

## 10. データ保存・同期仕様

### 10.1 端末ローカル保存
主なローカルストレージキー:
- `pfc_logs`（日次ログ）
- `pfc_settings`（目標・プロフィール・お気に入り）
- `pfc_food_dictionary`（食品辞書）
- `pfc_manage_foods_collapse_state`（食品管理画面の折りたたみ状態）

### 10.2 画面更新
- 保存後に `pfc-update` イベントを発火
- 各画面フックがイベント購読して再描画

### 10.3 初期食品データ
- `data/generated_foods.json` の既定食品をユーザー辞書へマージ

---

## 11. PWA / アプリ配布関連

- Web App Manifest により standalone 表示対応
- アイコン（192 / 512）設定
- Android TWA プロジェクトを同梱（`twa/`）

---

## 12. プライバシー・データ取り扱い

- 食事ログや設定は主に端末内に保存
- 取得情報は機能提供（計算・表示・入力補助）に利用
- 法令等を除き第三者提供しない方針

---

## 13. 現在の制限・注意点

- 写真解析機能はUIのみで、AI解析バックエンドは未接続
- バーコード連携はAPI/Redis設定が有効な環境で動作
- 端末ローカル保存のため、ブラウザデータ削除時に記録が消える
