# Androidアプリ公開までの詳細ステップ（PWA + TWA想定）

このドキュメントは、現在のNext.js（Webアプリ）を **PWA + TWA** でAndroidアプリとして公開するための具体的な手順をまとめたものです。  
バーコードスキャンなどのWebカメラ機能を活かしたまま、Google Playに公開することを前提にしています。

---

## 1. 前提整理

- **HTTPSで公開できる**こと（`getUserMedia` などカメラAPIはHTTPS必須）
- **Android端末実機での動作検証**を行う
- **Google Play Console アカウント**を用意（登録費用が必要）

---

## 2. PWA対応（必須）

### 2-1. `manifest.json` の用意

- `public/manifest.json` を作成（または既存のものを確認）
- `name` / `short_name` / `start_url` / `display` / `icons` を設定

### 2-2. Service Worker の導入

Next.jsでPWA化する場合、代表的には `next-pwa` を使います。  
導入する場合は以下のような流れになります。

- `next-pwa` をインストール
- `next.config.ts` にPWA設定を追加
- `public/` 配下に必要なアイコンを配置

> 既にPWA対応済みなら、設定と動作確認のみ行います。

---

## 3. HTTPSでの公開

### 3-1. ホスティング

- Vercel / Netlify / 自前サーバー いずれでも可
- HTTPSでアクセスできるURLを用意

### 3-2. 動作確認

- Android端末のChromeで直接アクセス
- カメラ起動、バーコードスキャンが安定するか確認

---

## 4. TWAアプリの作成

### 4-1. `bubblewrap` のセットアップ

```bash
npm i -g @bubblewrap/cli
```

### 4-2. TWAプロジェクト生成

```bash
bubblewrap init --manifest=https://<公開URL>/manifest.json
```

実行時に以下が求められます。

- アプリ名
- パッケージ名（例: `com.example.pfc`）
- キーストア情報

### 4-3. 生成物の確認

`app/` ディレクトリが生成されます。

---

## 5. Android App Bundle（AAB）の生成

```bash
bubblewrap build
```

成功すると `app-release-bundle.aab` が出力されます。

---

## 6. Google Play Consoleで公開準備

### 6-1. アプリ作成

- アプリ名、カテゴリ、言語を設定

### 6-2. ストア掲載情報

- 説明文（短文・全文）
- スクリーンショット（スマホ必須）
- アイコン（512x512）
- Feature Graphic（1024x500）

### 6-3. データセーフティ

- カメラ利用の有無
- 収集データの有無

### 6-4. プライバシーポリシー

- URLを用意して入力

---

## 7. テスト配信

### 7-1. 内部テスト

- 内部テストトラックにAABをアップロード
- テスターを追加して配信確認

### 7-2. クローズド / オープンテスト

必要に応じてステップを進め、問題がないか確認します。

---

## 8. 本番公開

- 本番トラックへAABをアップロード
- 審査完了後に公開

---

## 9. 公開後の注意点

- **TWAはWebの更新が即反映**される（アプリ更新不要）
- カメラやバーコード読み取りの挙動は端末差があるため、主要機種で検証を行う

---

## 10. 追加で検討すべきこと（任意）

### ネイティブ品質が必要な場合

- Capacitor + ネイティブバーコードスキャナープラグインを検討
- 既存Webとの併存が可能

---

## 付録：よくあるトラブル

### カメラ許可が出ない

- HTTPSか確認
- `start_url` が正しいか確認
- Android側のアプリ権限でカメラ許可を確認

### スキャン精度が悪い

- 解像度の調整（高解像度は重くなる）
- スキャン範囲をUIで絞り込み
- 端末依存の可能性を確認
